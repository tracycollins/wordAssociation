<!DOCTYPE html>
<html>

	<head>
	  <meta charset="utf-8">

		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/main.css">
		<link rel="icon" type="image/png" href="../favicon.png" />

		<style>
	    .heartbeatTable {
	      background-color:red;
	      border:1px solid gray;
	      cursor:pointer;
	      color:#888888;
	    }
	    .defaultButton {
	      background-color:black;
	      border:1px solid gray;
	      cursor:pointer;
	      color:#888888;
	    }
	    .defaultButton:hover {
	      color:white;
	      background-color:gray;
	    }

	    .defaultButton:focus {
	      outline:0;
	    }

	    .showHideButton {
	      background-color:black;
	      border:1px solid gray;
	      cursor:pointer;
	      color:#888888;
	    }
	    .showHideButton:hover {
	      color:white;
	      background-color:gray;
	    }

	    .showHideButton:focus {
	      outline:0;
	    }

		ul { 
		    display: block;
				list-style-position:inside;
		    list-style-type: disc;
		    margin-top: 1em;
		    margin-bottom: 1em;
		    margin-left: 0;
		    margin-right: 0;
		    padding-left: 2em;
		}

    .admin {
			font-size: 0.5em;
			margin-top: 10px;
			margin: 0.5em;
			padding: 2em;
			font-family: "Lucida Console", Monaco, monospace;
			font-weight: 100;
			line-height: 1.5em;
			background: #000000;
			color: #888888;
    }

		.adminControlPanel {
		    margin-left: 0.5em;
		    margin-right: 0;
		    padding-left: 2em;
		    font-size: 0.5em;
		}

		table, td {
		    border: 1px solid #444444;
				font-size: 1.2em;
				margin-top: 1em;
				margin-bottom: 1em;
				padding: 0.7em;
				font-family: "Lucida Console", Monaco, monospace;
				font-weight: 100;
				line-height: 1.2em;
				background: #111111;
				color: #999999;
		}

		th {
		    border: 2px solid #880000;
				font-size: 1.2em;
				margin-top: 1em;
				margin-bottom: 1em;
				padding: 0.7em;
				font-family: "Lucida Console", Monaco, monospace;
				font-weight: 100;
				line-height: 1.2em;
				background: #000000;
				color: #CCCCCC;
		}

		label {
			color:#888888;
		}

    .bar-text {
				color: #CCCCCC;
				font-family: "Lucida Console", Monaco, monospace;
				font-size: 1.5em;
				font-weight: 100;
				line-height: 1.2em;
    }
    .bar {
        height: 5px;
        width: 500px;
        background-color: #444444;
    }
    .bar > svg {
        height: 100%;
        display: block;
    }

		</style>

		<link rel="stylesheet" href="css/progressbar.css" />
		<script src="/js/libs/progressbar.js"></script>
		<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.0/moment.min.js"></script>
		<script src="/node_modules/hashmap/hashmap.js"></script>

	</head>

	<body>

	    <div id='admin' class='admin' font-size=0.1em>
				<br>
		    <h1>WORD ASSOCIATION ADMIN</h1>
				<br>
				<hr>
				<br>
				<input id="updateBhtReqs" type="number" name="bhtReqs">
				<button id="updateBhtReqsButton" class="showHideButton" onclick="updateBhtReqs()">UPDATE BHT REQS</button>
				<br>
				<br>
				<input id="setWordCacheTtl" type="number" name="wordCacheTtl">
				<button id="setWordCacheTtlButton" class="showHideButton" onclick="setWordCacheTtl()">SET WORD CACHE TTL</button>
				<br>
				<br>
				<hr>
				<br>
				<button id="testModeButton" class="showHideButton" onclick="setTestMode()">TEST MODE</button>
				<br>
				<br>
				<hr>
				<br>
				<br>
		    <div class="bar-text" id="bht-requests-bar-text"></div>
		    <div class="bar" id="bht-requests-bar"></div>
				<br>
		    <div class="bar-text" id="viewers-bar-text"></div>
		    <div class="bar" id="viewers-bar"></div>
				<br>
		    <div class="bar-text" id="users-bar-text"></div>
		    <div class="bar" id="users-bar"></div>
				<br>
		    <div class="bar-text" id="test-users-bar-text"></div>
		    <div class="bar" id="test-users-bar"></div>
				<br>
		    <div class="bar-text" id="delta-response-bar-text"></div>
		    <div class="bar" id="delta-response-bar"></div>
				<br>
				<br>
	    	<table id='heartbeat_table' class'heartbeatTable'></table>

		  <div id='admin_panel' >
				<br/>
		    	<h2>ADMINS</h2>
				<br/>
				<button id="showHideButton" class="showHideButton" onclick="toggleConnectedAdmins()">show/hide connected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleDisconnectedAdmins()">show/hide disconnected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleIpAdmins()">show/hide admin ip</button>
				<br/>
				<br/>
			  <div id='server_admins' ></div>
			</div>

	    <div id='admins' ><ul id='admin_ip_list'></ul></div>
	    <hr>
	    <div id='admins' ><ul id='admin_session_list'></ul></div>

	    <br>
	    <hr>
	    <hr>

		  <div id='client_panel' >
				<br/>
		    	<h2>CLIENTS</h2>
				<br/>
				<button id="showHideButton" class="showHideButton" onclick="toggleIpClients()">show/hide client ip</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleConnectedClients()">show/hide connected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleDisconnectedClients()">show/hide disconnected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleHideTestClients()">show/hide test clients</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleHideBotClients()">show/hide bot clients</button>
				<br/>
				<br/>
			    <div id='server_clients' ></div>
			</div>

	    <div id='clients' >
	    	<table id='client_ip_table' class'clientIpTable'>
	    		<thead id='client_ip_table_head'>
	    		</thead>
	    		<tbody id='client_ip_table_body'>
	    		</tbody>
	    	</table>
				<br/>
				<br/>
				<br/>
	    	<table id='client_session_table' class'clientSessionTable'>
	    		<thead id='client_session_table_head'>
	    		</thead>
	    		<tbody id='client_session_table_body'>
	    		</tbody>
	    	</table>
	    </div>

	    <hr>

		<script type="text/javascript">

			var ONE_MB = 1024*1024;
			var ONE_GB = ONE_MB*1024;

			var defaultDateTimeFormat = "YYYY-MM-DD HH:mm:ss ZZ";
			var defaultTimePeriodFormat = "HH:mm:ss";

			function getTimeNow() {
				var d = new Date();
				return d.getTime();
			}

			var currentTime = getTimeNow();

			var heartBeatTimeoutFlag = false ;
			var serverCheckInterval = 1000 ;
			var maxServerHeartBeatWait = 30000 ;


			console.log("ADMIN PAGE");

			var adminConfig = {} ;

			var testMode = false ;

			adminConfig['testMode'] = testMode ;

			var searchByDateTimeEnable = false;
			var searchByDateTimeContinueEnable = false;
			var showTestClients = false ;
			var showBotClients = false ;

			// var socket = io.connect();
			var socket = io.connect('/admin');
			// var socket = io.connect('http://word.threeceelabs.com/admin');
			// var socket = io.connect('http://localhost:9997/admin');
			// var socket = io.connect('http://threeceedev.dyndns.org/');

			var googleOauthUrl = 0;


			var adminIpHashMap = new HashMap();
			var adminSocketIdHashMap = new HashMap();
			var numberAdminIpAddresses = adminIpHashMap.count();
			var showConnectedAdmins = false ;
			var showDisconnectedAdmins = false ;
			var showIpAdmins = false ;

			var adminIpHashMapKeys = [];
			var adminSocketIdHashMapKeys = [];

			var clientIpHashMapKeys = [];
			var clientSocketIdHashMapKeys = [];

			var clientIpHashMap = new HashMap();
			var clientSocketIdHashMap = new HashMap();
			var numberClientIpAddresses = clientIpHashMap.count();

			var clientConnectedColor = "#00aa00";
			var testClientConnectedColor = "#888888";
			var clientDisconnectedColor = "#aa0000";
			var testClientDisonnectedColor = "#880000";
			var showConnectedClients = false ;
			var showDisconnectedClients = false ;
			var showIpClients = false ;

			var clientSessionTableHead = document.getElementById('client_session_table_head');
			var clientSessionTableBody = document.getElementById('client_session_table_body');

			var clientIpTableHead = document.getElementById('client_ip_table_head');
			var clientIpTableBody = document.getElementById('client_ip_table_body');

			var startColor = '#008000';
			var midColor = '#F9CD2B';
			var endColor = '#CC0000';

			var bhtRequestsBar;
			var bhtRequestsBarPercent = 0;

	    var bhtRequestsBarDiv = document.getElementById('bht-requests-bar');
			bhtRequestsBar = new ProgressBar.Line(bhtRequestsBarDiv, {});
			bhtRequestsBar.animate(0);
	    var bhtRequestsBarText = document.getElementById('bht-requests-bar-text');

			var viewersBar;
	    var viewersBarDiv = document.getElementById('viewers-bar');
			viewersBar = new ProgressBar.Line(viewersBarDiv, {});
			viewersBar.animate(0);
	    var viewersBarText = document.getElementById('viewers-bar-text');

			var usersBar;
	    var usersBarDiv = document.getElementById('users-bar');
			usersBar = new ProgressBar.Line(usersBarDiv, {});
			usersBar.animate(0);
	    var usersBarText = document.getElementById('users-bar-text');

			var testUsersBar;
	    var testUsersBarDiv = document.getElementById('test-users-bar');
			testUsersBar = new ProgressBar.Line(testUsersBarDiv, {});
			testUsersBar.animate(0);
	    var testUsersBarText = document.getElementById('test-users-bar-text');

	    var deltaResponsesMax = 1;
			var deltaResponseBar;
	    var deltaResponseBarDiv = document.getElementById('delta-response-bar');
			deltaResponseBar = new ProgressBar.Line(deltaResponseBarDiv, { duration: 200 });
			deltaResponseBar.animate(0);
	    var deltaResponseBarText = document.getElementById('delta-response-bar-text');

			var heartBeat = {} ;
			var lastTimeoutHeartBeat = null ;

			function setValue(id,newvalue) {
			  var s= document.getElementById(id);
			  s.value = newvalue;
			}    

			var jsonPrint = function (obj){
			  return JSON.stringify(obj, null, 2);
			}

			window.onload=function() {
			}			

			function getTimeStamp(inputTime) {
				var cDate, cTime;
				var options = {
				    weekday: "long", year: "numeric", month: "numeric",
				    day: "numeric", hour: "2-digit", hour12: false,  minute: "2-digit"
				  };

			  if (typeof inputTime === 'undefined') {
			    cDate = new Date().toDateString("en-US", options);
			    cTime = new Date().toTimeString('en-US', options);
			  }
			  else {
			    cDate = new Date(inputTime).toDateString("en-US", options);
			    cTime = new Date(inputTime).toTimeString('en-US', options);
			  }
			  return cDate + " - " + cTime;
			}

			function msToTime(duration) {
		    var milliseconds = parseInt((duration%1000)/100)
		        , seconds = parseInt((duration/1000)%60)
		        , minutes = parseInt((duration/(1000*60))%60)
		        , hours = parseInt((duration/(1000*60*60))%24)
		        , days = parseInt(duration/(1000*60*60*24));

		    var daysInt = days ;
		    days = (days < 10) ? "0" + days : days;
		    hours = (hours < 10) ? "0" + hours : hours;
		    minutes = (minutes < 10) ? "0" + minutes : minutes;
		    seconds = (seconds < 10) ? "0" + seconds : seconds;

		    if (daysInt > 0){
			    return days + " DAYS | " + hours + ":" + minutes + ":" + seconds ;
		    }
		    else{
			    return hours + ":" + minutes + ":" + seconds ;
		    }
			}

			function sortIpHashMapByConnectTime(ipHashMap){
			}

			function serverClear(){
				console.log("... CLEARING SERVER INFO ...\n");
				heartBeatTimeoutFlag = false ;
				adminIpHashMap.clear();
				adminSocketIdHashMap.clear();			
				clientIpHashMap.clear();
				clientSocketIdHashMap.clear();			
				updateServerHeartbeat(heartBeat, heartBeatTimeoutFlag, lastTimeoutHeartBeat);
			}

			function updateAdminConfig(config) {

				// var config = JSON.parse(rxConfig);

			  console.log("ADMIN CONFIG CHANGE\n" + jsonPrint(config));

			  if (typeof config.testMode !== 'undefined') {
			    console.log("   ---> CONFIG_CHANGE: testMode: " + config.testMode);
			    testMode = config.testMode;
			    setTestMode(config.testMode);
			  }
			}

			function tableCreateRow(parentTable, options, cells){

        var tr = parentTable.insertRow();
        var tdTextColor = options.textColor;
        var tdBgColor = options.backgroundColor || '#222222';

        if (options.trClass) {
        	tr.setAttribute("class", options.trClass);
        }

        if (options.headerFlag){
		      cells.forEach(function(content){
			      var th = tr.insertCell();
			      th.appendChild(document.createTextNode(content));
			      th.style.color = tdTextColor ;
			      th.style.backgroundColor = tdBgColor ;
		      });     	
        }
        else {
		      cells.forEach(function(content){
			      var td = tr.insertCell();
			      // var td2 = td.insertCell();
			      td.appendChild(document.createTextNode(content));
			      td.style.color = tdTextColor ;
			      td.style.backgroundColor = tdBgColor ;
		      });
        }
			}

			function requestSessions(reqSessionsOptions){
				console.log("TX REQ ADMIN SESSION\n" + JSON.stringify(reqSessionsOptions, null, 3));
				socket.emit('REQ_ADMIN_SESSION', reqSessionsOptions);
			}

			setInterval (function () {
				currentTime = getTimeNow();
				updateAdminConnect();
				updateClientConnect();
			}, 1000 );


			socket.on('connect', function(){
				serverConnected = true ;
				console.log("\n===== ADMIN SERVER CONNECTED =====\n" 
					+ getTimeStamp()
					);
				serverClear();
				requestSessions(reqSessionsOptions);
			});

			socket.on('disconnect', function(){
				serverConnected = false ;
				console.log("\n***** SERVER DISCONECTED *****\n" 
					+ getTimeStamp()
					);
				serverClear();
			});

		  socket.on("ADMIN_CONFIG", function(rxAdminConfig){
		    console.log("\n*** RX ADMIN CONFIG ***\n" 
		      // + rxAdminConfig);
		      + JSON.stringify(rxAdminConfig, null, 3));
		    updateAdminConfig(rxAdminConfig);
		  });

		  socket.on("CONFIG_CHANGE", function(rxAdminConfig){
		    var previousProperty ;
		  
		    console.log("\n*** RX ADMIN CONFIG CHANGE ***\n" 
		      + JSON.stringify(rxAdminConfig, null, 3));
		  
		    console.log("\nPREVIOUS ADMIN CONFIG:\n" + JSON.stringify(adminConfig, null, 3));
		    for(var configPropertyName in rxAdminConfig) {
		      console.log("configPropertyName: " + configPropertyName + " | " + rxAdminConfig[configPropertyName]);
		      if (typeof adminConfig !== 'undefined'){
			      previousProperty = adminConfig[configPropertyName];
		      }
		      adminConfig[configPropertyName] = rxAdminConfig[configPropertyName];
		      console.log(configPropertyName + " was: " + previousProperty + " | now: " + adminConfig[configPropertyName]);
		    }
		    console.log("\nNEW ADMIN CONFIG:\n" + JSON.stringify(adminConfig, null, 3));
		    updateAdminConfig(adminConfig);
		  });


			socket.on('ADMIN IP', function(rxIpObj){
				var ipObj = JSON.parse(rxIpObj) ;
				console.log("RXCD ADMIN IP  " + ipObj.ip + " | " + ipObj.domain);
				adminIpHashMap.set(ipObj.ip, ipObj);
				numberAdminIpAddresses = adminIpHashMap.count();
				adminIpHashMapKeys = adminIpHashMap.keys();
				adminIpHashMapKeys.sort();
			});

			var reqSessionsOptions = {
				sessionType: 'ALL', 
				sessionState: 'CONNECTED', 
				maxSessions: 10
			}

			socket.on('ADMIN SESSION', function(rxAdminObj){

				var ao = JSON.parse(rxAdminObj) ;

				console.log("RXCD ADMIN SESSION: " + ao.adminObj.socketId + " | " + ao.adminObj.ip + " | " + ao.adminObj.domain + " | CONNECTED: " + ao.adminObj.connected);

				adminIpHashMap.set(ao.adminObj.ip, ao.adminObj);
				numberAdminIpAddresses = adminIpHashMap.count();

				adminSocketIdHashMap.set(ao.adminObj.socketId, ao.adminObj);
				adminSocketIdHashMapKeys = adminSocketIdHashMap.keys();
				adminSocketIdHashMapKeys.sort();
				updateAdminConnect(ao.adminObj);
			});

			socket.on('CLIENT IP', function(rxIpObj){
				var ipObj = JSON.parse(rxIpObj) ;

				if (typeof ipObj.domain === 'undefined'){
					ipObj.domain = 'UNKNOWN';
				}
				
				console.log("RXCD CLIENT IP " + ipObj.ip + " | " + ipObj.domain);
				clientIpHashMap.set(ipObj.ip, ipObj);
				numberClientIpAddresses = clientIpHashMap.count();
				clientIpHashMapKeys = clientIpHashMap.keys();
				clientIpHashMapKeys.sort();
			});

			socket.on('CLIENT SESSION', function(rxClientObj){

				var co = JSON.parse(rxClientObj) ;

				if (typeof co.clientObj.referer === 'undefined'){
					co.clientObj.referer = '';
				}

				if (typeof co.clientObj.numberOfConnections === 'undefined'){
					co.clientObj.numberOfConnections = 1;
				}
				

				clientIpHashMap.set(co.clientObj.ip, co.clientObj);
				numberClientIpAddresses = clientIpHashMap.count();

				clientSocketIdHashMap.set(co.clientObj.socketId, co.clientObj);
				clientSocketIdHashMapKeys = clientSocketIdHashMap.keys();
				clientSocketIdHashMapKeys.sort();

				console.log("RXCD CLIENT SESSION: [" + clientSocketIdHashMap.count() + "] "
					+ co.clientObj.socketId 
					// + " | T: " + co.clientObj.config.type 
					+ " | I: " + co.clientObj.ip 
					+ " | D: " + co.clientObj.domain 
					+ " | R: " + co.clientObj.referer 
					+ " | CONNECTED: " + co.clientObj.connected
					);

				// console.log(jsonPrint(co.clientObj));

				updateClientConnect();
			});

			socket.on("SESSION_UPDATE", function(sessionObject){
			  console.log("> RX " + sessionObject.sourceWord.nodeId + " > " + sessionObject.targetWord.nodeId) ;
			});

			var hbIndex = 0;
			
			socket.on('HEARTBEAT', function(rxHeartbeat){
				hbIndex++;
				heartBeat = rxHeartbeat ;
				if (rxHeartbeat.deltaResponsesReceived > deltaResponsesMax) deltaResponsesMax = rxHeartbeat.deltaResponsesReceived;
				heartBeatTimeoutFlag = false ;
			});

			// updateServerHeartbeat
			var serverCheckTimeout = setInterval(function(){
				numberClientIpAddresses = clientIpHashMap.count();
				numberAdminIpAddresses = adminIpHashMap.count();

				if (Date.now() > (heartBeat.timeStamp + maxServerHeartBeatWait)){
					heartBeatTimeoutFlag = true ;
					lastTimeoutHeartBeat = heartBeat ;
					console.error("***** SERVER HEARTBEAT TIMEOUT ***** " 
						+ getTimeStamp() 
						+ " | LAST SEEN: " + getTimeStamp(heartBeat.timeStamp)
						+ msToTime(Date.now() - heartBeat.timeStamp) + " AGO" 
					);
				}
 				updateServerHeartbeat(heartBeat, heartBeatTimeoutFlag, lastTimeoutHeartBeat);
			}, serverCheckInterval); ;

			function setTestMode(inputTestMode){

				var serverConfigUpdateFlag = false;

				if (typeof inputTestMode !== 'undefined'){
					serverConfigUpdateFlag = true ;
					testMode = inputTestMode;
				}
				else {
					testMode = !testMode;
				}
				console.log("testMode: " + testMode);

				var config = {
					testMode: testMode
				}

				if (testMode){
					document.getElementById("testModeButton").style.color="red";
					document.getElementById("testModeButton").style.border="2px solid red";
				}
				else {
					document.getElementById("testModeButton").style.color="white";
					document.getElementById("testModeButton").style.border="1px solid gray";
				}

				if (!serverConfigUpdateFlag){
					console.log("***> SENT CONFIG: " + JSON.stringify(config, null, 3));
					socket.emit('CONFIG', JSON.stringify(config));
				}
				else {
					console.log("---> UPDATED CONFIG: " + JSON.stringify(config, null, 3));
				}
			}

			function sendServerConfig(e){

				var config = {
					testMode: testMode
				}

				var configHasValues = false;

				if ((typeof e === 'undefined' ) || (e.keyCode == 13)) {
					if (configHasValues){
						console.log("***> SENT CONFIG: " + JSON.stringify(config, null, 3));
						socket.emit('CONFIG', JSON.stringify(config));
						return false ;
					}
					else {
						console.log("sendServerConfig: NO VALUES SET ... SKIPPING ...");
					}
				}
			}


			function setWordCacheTtl(){
				var newWordCacheTtl = document.getElementById("setWordCacheTtl").value;
				console.log("SET WORD CACHE TTL: " + newWordCacheTtl);
				socket.emit("SET_WORD_CACHE_TTL", newWordCacheTtl);
			}

			function updateBhtReqs(){
				var newBhtRequests = document.getElementById("updateBhtReqs").value;
				console.log("UPDATE BHT REQS: " + newBhtRequests);
				socket.emit("UPDATE_BHT_REQS", newBhtRequests);
			}

			function toggleTestMode(){
				console.log("SET TEST MODE: " + testMode);
				socket.emit("SET_TEST_MODE", testMode);
			}

			function toggleIpAdmins(){
				updateAdminConnect({ showIp: "toggle" });
			}

			function toggleConnectedAdmins(){
				updateAdminConnect({ showConnected: "toggle" });
			}

			function toggleDisconnectedAdmins(){
				updateAdminConnect({ showDisconnected: "toggle" });
			}

			function toggleIpClients(){
				updateClientConnect({ showIp: "toggle" });
			}

			function toggleConnectedClients(){
				updateClientConnect({ showConnected: "toggle" });
			}

			function toggleDisconnectedClients(){
				updateClientConnect({ showDisconnected: "toggle" });
			}

			function toggleHideTestClients(){
				updateClientConnect({ showTestClients: "toggle" });
			}

			function toggleHideBotClients(){
				updateClientConnect({ showBotClients: "toggle" });
			}

			function updateAdminConnect(req) {

				numberAdminsConnected = 0;

				if (typeof req === 'undefined'){
				}
				else {
					if (req.showConnected == 'toggle') {
						showConnectedAdmins = !showConnectedAdmins ;
					}
					if (req.showDisconnected == 'toggle') {
						showDisconnectedAdmins = !showDisconnectedAdmins ;
					}
					if (req.showIp == 'toggle') {
						showIpAdmins = !showIpAdmins ;
					}
				}

				var adminIpListElement = document.getElementById("admin_ip_list");
				var adminSessionListElement = document.getElementById("admin_session_list");

				while(adminIpListElement.childNodes.length >= 1) {
					adminIpListElement.removeChild(adminIpListElement.firstChild);
				}
				
				while(adminSessionListElement.childNodes.length >= 1) {
					adminSessionListElement.removeChild(adminSessionListElement.firstChild);
				}
				
				if (showIpAdmins) {
					adminIpHashMap.forEach(function(value, key) {
						var adminIpListItem = document.createElement('li');
						adminIpListItem.style.color = clientConnectedColor;

						adminIpListElement.appendChild(adminIpListItem);
						adminIpListItem.innerHTML = adminIpListItem.innerHTML 
							+ (
								key
								+ ' | ' + value.domain  
								+ ' | LAST SEEN: ' + getTimeStamp(value.lastSeen)
								+ ' | CONNECTIONS: ' + value.numberOfConnections 
							) ;
					});				
				}
				
				if (showConnectedAdmins) {
					adminSocketIdHashMap.forEach(function(value, key) {

						// console.log("showConnectedAdmins\n" + JSON.stringify(value));

					  if (value.connected == true) {

							var adminSessionListItem = document.createElement('li');					
							adminSessionListItem.style.color = clientConnectedColor;
							adminSessionListElement.appendChild(adminSessionListItem);
							adminSessionListItem.innerHTML = adminSessionListItem.innerHTML 
								+ (value.ip 
								+ ' | ' + value.domain 
								+ ' | ' + key 
								+ ' | CONNECT: ' + getTimeStamp(value.connectTime)
								+ ' | DISCONNECT: ' + getTimeStamp(value.disconnectTime)
								+ ' | CONNECT TIME: ' + msToTime(heartBeat.timeStamp - value.connectTime)
								) ;
						}
					});			
				}		
				
				if (showDisconnectedAdmins) {
					adminSocketIdHashMap.forEach(function(value, key) {
					  if (value.connected == false) {

							var adminSessionListItem = document.createElement('li');					
							adminSessionListItem.style.color = clientDisconnectedColor;
					    var timeConnected = value.disconnectTime - value.connectTime ;
							adminSessionListElement.appendChild(adminSessionListItem);
							adminSessionListItem.innerHTML = adminSessionListItem.innerHTML 
								+ (value.ip 
								+ ' | ' + value.domain 
								+ ' | ' + key 
								+ ' | CONNECT: ' + getTimeStamp(value.connectTime)
								+ ' | DISCONNECT: ' + getTimeStamp(value.disconnectTime)
								+ ' | CONNECT TIME: ' + msToTime(value.disconnectTime - value.connectTime)
								) ;
						}
					});			
				}		
			}

			function initClientConnect(options){
				// tableCreateRow(clientIpTableHead, options, ['UNIQUE CLIENTS']);  // 2nd arg is headerFlag
				tableCreateRow(clientIpTableHead, options, ['CLIENTS', 'IP', 'DOMAIN', 'LAST SEEN', 'AGO', 'SESSIONS']);  // 2nd arg is headerFlag
			}

			function initClientSession(options){
				// tableCreateRow(clientSessionTableHead, options, ['CLIENT SESSIONS']);  // 2nd arg is headerFlag
				tableCreateRow(clientSessionTableHead, options, ['SESSIONS', 'IP', 'DOMAIN', 'SESSION', 'CONNECT', 'DISCONNECT', 'TIME CONNECTED']);  // 2nd arg is headerFlag
			}

			function updateClientConnect(req){

				var clientIpTableBodyOptions = {
					headerFlag: false,
					textColor: '#AAAAAA',
					backgroundColor: 'black'
				};

				var clientSessionTableBodyOptions = {
					headerFlag: false,
					textColor: '#AAAAAA',
					backgroundColor: 'black'
				};

				while(clientIpTableBody.childNodes.length > 1) {
					clientIpTableBody.removeChild(clientIpTableBody.lastChild);
				}

				while(clientSessionTableBody.childNodes.length > 1) {
					clientSessionTableBody.removeChild(clientSessionTableBody.lastChild);
				}

				if (typeof req === 'undefined'){
				}
				else {
					if (req.showConnected == 'toggle') {
						showConnectedClients = !showConnectedClients ;
						console.log("showConnectedClients: " + showConnectedClients);
					}
					if (req.showDisconnected == 'toggle') {
						showDisconnectedClients = !showDisconnectedClients ;
					}
					if (req.showIp == 'toggle') {
						showIpClients = !showIpClients ;
						console.log("showIpClients " + showIpClients);
					}
					if (req.showTestClients == 'toggle') {
						showTestClients = !showTestClients ;
						console.log("showTestClients " + showTestClients);
					}
					if (req.showBotClients == 'toggle') {
						showBotClients = !showBotClients ;
						console.log("showBotClients " + showBotClients);
					}
				}

				if (showIpClients) {

					var numberUniqueClients = 0;
					var elapsedSinceLastSeen = 0;
					var key;
					var value = {};

					for (var i=0; i<clientIpHashMapKeys.length; i++){

						 key = clientIpHashMapKeys[i];
						 value = clientIpHashMap.get(clientIpHashMapKeys[i]);
						// console.log("KEY: " + key + "\n" + jsonPrint(value));

						if (!showBotClients && ((value.domain.indexOf("googlebot") >= 0))) {
						}
						else if (!showTestClients && ((value.domain.indexOf("googleusercontent") >= 0) 
								|| (value.referer.indexOf('TEST') >= 0)
								|| (value.config.type.indexOf('TEST') >= 0)
								|| (value.domain.indexOf("googlebot") >= 0))) {
						}
						else {
							
							if ((value.domain.indexOf("googleusercontent") >= 0) 
								|| (value.referer.indexOf('TEST') >= 0)
								|| (value.config.type.indexOf('TEST') >= 0)
								|| (value.domain.indexOf("googlebot") >= 0)
								) {
								clientIpTableBodyOptions.textColor = testClientConnectedColor ;
							}
							else{
								clientIpTableBodyOptions.textColor = clientConnectedColor ;
							}

							numberUniqueClients++;

							if (value.connected == true) {
								elapsedSinceLastSeen = 0 ;
							}
							else if (value.lastSeen > currentTime) {
								elapsedSinceLastSeen = 0 ;
							}
							else {
								elapsedSinceLastSeen = heartBeat.timeStamp - value.lastSeen;
							}

							tableCreateRow(clientIpTableBody, clientIpTableBodyOptions, 
								[
									numberUniqueClients,
									key, 
									value.domain, 
									getTimeStamp(value.lastSeen), 
									msToTime(elapsedSinceLastSeen),
									value.numberOfConnections
								]
							);
						}
					}			
				}

				if (showConnectedClients) {

					clientSessionTableBodyOptions.textColor = clientConnectedColor ;

					var numberConnected = 0;
					var connectTime = 0;
					var key;
					var value = {};


					for (var j=0; j<clientSocketIdHashMapKeys.length; j++){

						 key = clientSocketIdHashMapKeys[j];
						 value = clientSocketIdHashMap.get(clientSocketIdHashMapKeys[j]);

						// console.log("KEY: " + key + "\n" + jsonPrint(value));

						if (typeof value.referer === 'undefined'){
							value.referer = '';
						}


						if (!showTestClients && ((value.domain.indexOf("googleusercontent") >= 0) 
							|| (value.referer.indexOf('TEST') >= 0))
							) 
						{
						}
						else if (!showBotClients && ((value.domain.indexOf("googlebot") >= 0))) {
						}
						else{
							if (value.connected == true) { 

								numberConnected++;

								if (typeof value.referer !== 'undefined') {
									if (value.referer.indexOf('TEST') >= 0) {
										clientSessionTableBodyOptions.textColor = testClientConnectedColor ;
									}
									else {
										clientSessionTableBodyOptions.textColor = clientConnectedColor ;
									}
								} 
								else if (value.domain.indexOf("googlebot") >= 0) {
									clientSessionTableBodyOptions.textColor = testClientConnectedColor ;
								}
								else if (value.domain.indexOf("googleusercontent") >= 0) {
									clientSessionTableBodyOptions.textColor = testClientConnectedColor ;
								}
								else{
									clientSessionTableBodyOptions.textColor = clientConnectedColor ;
								}
								
								// console.log("KEY: " + key + "\n" + jsonPrint(value));
								// console.log("heartBeat.timeStamp: " + heartBeat.timeStamp + " | " + value.connectTime);
								connectTime = heartBeat.timeStamp - value.connectTime ;

								tableCreateRow(clientSessionTableBody, clientSessionTableBodyOptions, 
									[
										numberConnected,
										value.ip, 
										value.domain, 
										key, 
										getTimeStamp(value.connectTime), 
										'', 
										msToTime(connectTime)
									]
								);
							}
						}
					}
				}		

				if (showDisconnectedClients) {

					clientSessionTableBodyOptions.textColor = clientDisconnectedColor ;

					var numberDisconnected = 0;
					var connectedTime = 0;

					for (var k=0; k<clientSocketIdHashMapKeys.length; k++){

						var key = clientSocketIdHashMapKeys[k];
						var value = clientSocketIdHashMap.get(clientSocketIdHashMapKeys[k]);

						if (!showTestClients && ((value.domain.indexOf("googleusercontent") >= 0) 
							|| (value.referer.indexOf('TEST') >= 0)
							|| (value.config.type.indexOf('TEST') >= 0)
							)
							) {
						}
						else{
							if (value.connected == false) { 

								numberDisconnected++;

								connectedTime = value.disconnectTime - value.connectTime ;
							    
								tableCreateRow(clientSessionTableBody, clientSessionTableBodyOptions, 
									[
										numberDisconnected,
										value.ip, 
										value.domain, 
										key, 
										getTimeStamp(value.connectTime), 
										getTimeStamp(value.disconnectTime), 
										msToTime(connectedTime)
									]
								);

							}
						}
					}			
				}		
			}

			function updateServerHeartbeat(heartBeat, timeoutFlag, lastTimeoutHeartBeat) {

				// console.log("updateServerHeartbeat: timeoutFlag: " + timeoutFlag);

				bhtRequestsBar.animate(heartBeat.bhtRequests/heartBeat.bhtRequestLimit);

				if (100*heartBeat.bhtRequests/heartBeat.bhtRequestLimit >= 90) {
					bhtRequestsBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.bhtRequests/heartBeat.bhtRequestLimit >= 50) {
					bhtRequestsBar.path.setAttribute('stroke', midColor);
				}
				else {
					bhtRequestsBar.path.setAttribute('stroke', startColor);
				}

				bhtRequestsBarText.innerHTML =  
					'BHT REQS'
					+ ' | USED: ' + heartBeat.bhtRequests + ' ' + (heartBeat.bhtRequests/heartBeat.bhtRequestLimit * 100).toFixed(0) + '%'
					+ ' | REMAIN: ' + (heartBeat.bhtRequestLimit - heartBeat.bhtRequests)
				;


				viewersBar.animate(heartBeat.numberViewers/heartBeat.maxNumberViewers);

				if (100*heartBeat.numberViewers/heartBeat.maxNumberViewers >= 90) {
					viewersBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberViewers/heartBeat.maxNumberViewers >= 50) {
					viewersBar.path.setAttribute('stroke', midColor);
				}
				else {
					viewersBar.path.setAttribute('stroke', startColor);
				}

				viewersBarText.innerHTML = (heartBeat.numberViewers) + ' VIEWERS | ' + (heartBeat.numberViewersMax) + ' MAX | ' + moment(heartBeat.numberViewersMaxTime).format(defaultDateTimeFormat);


				usersBar.animate(heartBeat.numberUsers/heartBeat.maxNumberUsers);

				if (100*heartBeat.numberUsers/heartBeat.maxNumberUsers >= 90) {
					usersBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberUsers/heartBeat.maxNumberUsers >= 50) {
					usersBar.path.setAttribute('stroke', midColor);
				}
				else {
					usersBar.path.setAttribute('stroke', startColor);
				}

				usersBarText.innerHTML = (heartBeat.numberUsers) + ' USERS | ' + (heartBeat.numberUsersMax) + ' MAX | ' + moment(heartBeat.numberUsersMaxTime).format(defaultDateTimeFormat);


				testUsersBar.animate(heartBeat.numberTestUsers/heartBeat.maxNumberTestUsers);

				if (100*heartBeat.numberTestUsers/heartBeat.maxNumberTestUsers >= 90) {
					testUsersBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberTestUsers/heartBeat.maxNumberTestUsers >= 50) {
					testUsersBar.path.setAttribute('stroke', midColor);
				}
				else {
					testUsersBar.path.setAttribute('stroke', startColor);
				}

				testUsersBarText.innerHTML = (heartBeat.numberTestUsers) + ' TEST USERS | ' + (heartBeat.numberTestUsersMax) + ' MAX | ' + moment(heartBeat.numberTestUsersMaxTime).format(defaultDateTimeFormat);


				deltaResponseBar.animate(heartBeat.deltaResponsesReceived/deltaResponsesMax);

				if (heartBeat.deltaResponsesReceived >= 90) {
					deltaResponseBar.path.setAttribute('stroke', endColor);
				}
				else if (heartBeat.deltaResponsesReceived >= 50) {
					deltaResponseBar.path.setAttribute('stroke', midColor);
				}
				else {
					deltaResponseBar.path.setAttribute('stroke', startColor);
				}

				deltaResponseBarText.innerHTML = heartBeat.deltaResponsesReceived + ' RESPONSES/SEC | ' + deltaResponsesMax + ' MAX';




		    var heatbeatTable = document.getElementById('heartbeat_table');

				while(heatbeatTable.childNodes.length > 0) {
					heatbeatTable.removeChild(heatbeatTable.firstChild);
				}

				tableCreateRow(heatbeatTable, false, ['LOCAL TIME', getTimeStamp()]);

				if (timeoutFlag){
					tableCreateRow(heatbeatTable, false, ['*** SERVER TIMEOUT ***', (msToTime(Date.now() - heartBeat.timeStamp)) + ' AGO']);
					var x = heatbeatTable.getElementsByTagName("td");
					x[2].style.color = "white";            
					x[2].style.backgroundColor = "red";            
				}
				else if (lastTimeoutHeartBeat){

					tableCreateRow(
						heatbeatTable, 
						false, 
						[
							'* SERVER TIMEOUT *', 
							getTimeStamp(lastTimeoutHeartBeat.timeStamp), 
							msToTime(Date.now() - lastTimeoutHeartBeat.timeStamp) + ' AGO'
						]);	

					var x = heatbeatTable.getElementsByTagName("td");
					x[2].style.color = "white";            
					x[2].style.backgroundColor = '#880000';            
				}

				var bhtOLTmoment;

				if (heartBeat.bhtOverLimitTime == 0) {
					bhtOLTmoment = "" ;
				}
				else {
					bhtOLTmoment = moment(heartBeat.bhtOverLimitTime).format("YYYY-MM-DD HH:mm:ss ZZ");
				}
				var bhtLRTmoment = moment(heartBeat.bhtLimitResetTime).format("YYYY-MM-DD HH:mm:ss ZZ");

				var bhtOptions = false ;
				var memoryAvailable = (heartBeat.memoryAvailable/heartBeat.memoryTotal)*100;

				tableCreateRow(heatbeatTable, false, ['SERVER TIME', getTimeStamp(heartBeat.timeStamp)]);
				tableCreateRow(heatbeatTable, false, ['SERVER UPTIME', msToTime(heartBeat.upTime)]);
				tableCreateRow(heatbeatTable, false, ['APP START TIME', getTimeStamp(heartBeat.startTime)]);
				tableCreateRow(heatbeatTable, false, ['APP RUNTIME', msToTime(heartBeat.runTime)]);
				tableCreateRow(heatbeatTable, false, ['MEM AVAIL', memoryAvailable.toFixed(1) + '%'
					+ ' (' + parseInt(heartBeat.memoryAvailable/ONE_MB) + ' OF '
					+ parseInt(heartBeat.memoryTotal/ONE_MB) + ' MB)'
					]);

				if (typeof heartBeat.wordCacheStats !== 'undefined') {

					var hmr = (heartBeat.wordCacheStats.hits/(1+heartBeat.wordCacheStats.misses)) ;

					tableCreateRow(heatbeatTable, false, ['WORD CACHE', 
						'TTL: ' + heartBeat.wordCacheTtl
						+ ' | K: ' + heartBeat.wordCacheStats.keys
						+ ' | H: ' + heartBeat.wordCacheStats.hits
						+ ' | M: ' + heartBeat.wordCacheStats.misses
						+ ' | HMR: ' + hmr.toFixed(2)
						]);

					// tableCreateRow(heatbeatTable, false, ['WORD CACHE', 
					// 	'TTL: ' + heartBeat.wordCacheTtl,
					// 	'K: ' + heartBeat.wordCacheStats.keys,
					// 	'H: ' + heartBeat.wordCacheStats.hits,
					// 	'M: ' + heartBeat.wordCacheStats.misses,
					// 	'HMR: ' + hmr.toFixed(2)
					// 	]);

				}

				tableCreateRow(heatbeatTable, false, ['TOTAL SESSIONS', heartBeat.totalSessions]);
				tableCreateRow(heatbeatTable, false, ['TOTAL WORDS', heartBeat.totalWords]);
				tableCreateRow(heatbeatTable, false, ['TOTAL PROMPTS', heartBeat.promptsSent]);
				tableCreateRow(heatbeatTable, false, ['TOTAL REPONSES', heartBeat.responsesReceived]);

				if (heartBeat.bhtOverLimitFlag){
			    var now = moment.utc();
			    now.utcOffset("-08:00");

			    bhtOptions = {textColor: "black", backgroundColor: "#999947"} ;

					tableCreateRow(heatbeatTable, bhtOptions, ['*** BHT OVER LIMIT ***', 
						(msToTime(now.diff(heartBeat.bhtOverLimitTime))) + ' AGO | ' 
						+ (msToTime(moment(heartBeat.bhtLimitResetTime).diff(now))) + ' REMAIN']);
				}

				// tableCreateRow(heatbeatTable, bhtOptions, ['TOTAL BHT REQS', heartBeat.bhtRequests]);
				tableCreateRow(heatbeatTable, bhtOptions, ['BHT OVER LIMIT', bhtOLTmoment]);
				tableCreateRow(heatbeatTable, bhtOptions, ['BHT LIMIT RESET', 
						bhtLRTmoment + ' | ' + (msToTime(moment(heartBeat.bhtLimitResetTime).diff(now))) + ' REMAIN'
					]);

				tableCreateRow(heatbeatTable, false, ['TOTAL MW REQS', heartBeat.mwRequests]);

				tableCreateRow(heatbeatTable, false, ['ADMINS', heartBeat.numberAdmins]);
				tableCreateRow(heatbeatTable, false, ['UTILS', heartBeat.numberUtils]);
				tableCreateRow(heatbeatTable, false, ['VIEWERS',heartBeat.numberViewers]);
				tableCreateRow(heatbeatTable, false, ['TEST VIEWERS',heartBeat.numberTestViewers]);
				// tableCreateRow(heatbeatTable, false, ['USERS', heartBeat.numberUsers]);
				// tableCreateRow(heatbeatTable, false, ['TEST USERS',heartBeat.numberTestUsers]);
				// tableCreateRow(heatbeatTable, false, ['TOTAL USERS', heartBeat.numberUsers + heartBeat.numberTestUsers]);
				// tableCreateRow(heatbeatTable, false, ['MAX USERS', heartBeat.maxNumberUsers]);
				tableCreateRow(heatbeatTable, false, ['MAX USERS TIME', getTimeStamp(heartBeat.maxNumberUsersTime)]);

				serverHeartbeatElement = document.getElementById("server_admins");

				while(serverHeartbeatElement.childNodes.length >= 1) {
					serverHeartbeatElement.removeChild(serverHeartbeatElement.firstChild);
				}

				serverHeartbeatElement.appendChild(serverHeartbeatElement.ownerDocument
					.createTextNode(numberAdminIpAddresses + " ADMINS UNIQUE IP " 
						+ " | " + heartBeat.numberAdmins + " CONNECTED"
						)
				);

				serverHeartbeatElement = document.getElementById("server_clients");

				while(serverHeartbeatElement.childNodes.length >= 1) {
					serverHeartbeatElement.removeChild(serverHeartbeatElement.firstChild);
				}
				serverHeartbeatElement.appendChild(serverHeartbeatElement.ownerDocument
					.createTextNode(numberClientIpAddresses + " CLIENT UNIQUE IP " + " | " + heartBeat.numberClients + " CONNECTED")
				);
			}

			initClientConnect({
				headerFlag: true,
				textColor: '#CCCCCC',
				backgroundColor: '#222222'
			});

			initClientSession({
				headerFlag: true,
				textColor: '#CCCCCC',
				backgroundColor: '#222222'
			});

		</script>

	</body>
</html>