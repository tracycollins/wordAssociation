<!DOCTYPE html>
<html>

	<head>
	  <meta charset="utf-8">

		<link rel="stylesheet" href="../css/base.css">
		<link rel="stylesheet" href="../css/main.css">
		<link rel="icon" type="image/png" href="../favicon.png" />

		<style>
	    .heartbeatTable {
	      background-color:red;
	      border:1px solid gray;
	      cursor:pointer;
	      color:#888888;
	    }
	    .defaultButton {
	      background-color:black;
	      border:1px solid gray;
	      cursor:pointer;
	      color:#888888;
	    }
	    .defaultButton:hover {
	      color:white;
	      background-color:gray;
	    }

	    .defaultButton:focus {
	      outline:0;
	    }

	    .showHideButton {
	      background-color:black;
	      border:1px solid gray;
	      cursor:pointer;
	      color:#888888;
	    }
	    .showHideButton:hover {
	      color:white;
	      background-color:gray;
	    }

	    .showHideButton:focus {
	      outline:0;
	    }

		ul { 
		    display: block;
				list-style-position:inside;
		    list-style-type: disc;
		    margin-top: 1em;
		    margin-bottom: 1em;
		    margin-left: 0;
		    margin-right: 0;
		    padding-left: 2em;
		}

    .admin {
			font-size: 0.5em;
			margin-top: 10px;
			margin: 0.5em;
			padding: 2em;
			font-family: "Lucida Console", Monaco, monospace;
			font-weight: 100;
			line-height: 1.5em;
			background: #000000;
			color: #888888;
    }

		.adminControlPanel {
		    margin-left: 0.5em;
		    margin-right: 0;
		    padding-left: 2em;
		    font-size: 0.5em;
		}

		table, td {
		    border: 1px solid #444444;
				font-size: 1.2em;
				margin-top: 1em;
				margin-bottom: 1em;
				padding: 0.7em;
				font-family: "Lucida Console", Monaco, monospace;
				font-weight: 100;
				line-height: 1.2em;
				background: #111111;
				color: #999999;
		}

		th {
		    border: 2px solid #880000;
				font-size: 1.2em;
				margin-top: 1em;
				margin-bottom: 1em;
				padding: 0.7em;
				font-family: "Lucida Console", Monaco, monospace;
				font-weight: 100;
				line-height: 1.2em;
				background: #000000;
				color: #CCCCCC;
		}

		label {
			color:#888888;
		}

    .bar-text {
				color: #CCCCCC;
				font-family: "Lucida Console", Monaco, monospace;
				font-size: 1.5em;
				font-weight: 100;
				line-height: 1.2em;
    }
    .bar {
        height: 5px;
        width: 500px;
        background-color: #444444;
    }
    .bar > svg {
        height: 100%;
        display: block;
    }

		</style>

		<link rel="stylesheet" href="css/progressbar.css" />
		<script src="/js/libs/progressbar.js"></script>
		<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.0/moment.min.js"></script>
		<script src="/node_modules/hashmap/hashmap.js"></script>

	</head>

	<body>

	    <div id='admin' class='admin' font-size=0.1em>
				<br>
		    <h1>WORD ASSOCIATION ADMIN</h1>
				<br>
				<hr>
				<br>
				<input id="updateBhtReqs" type="number" name="bhtReqs">
				<button id="updateBhtReqsButton" class="showHideButton" onclick="updateBhtReqs()">UPDATE BHT REQS</button>
				<br>
				<br>
				<input id="setWordCacheTtl" type="number" name="wordCacheTtl">
				<button id="setWordCacheTtlButton" class="showHideButton" onclick="setWordCacheTtl()">SET WORD CACHE TTL</button>
				<br>
				<br>
				<hr>
				<br>
				<button id="testModeButton" class="showHideButton" onclick="setTestMode()">TEST MODE</button>
				<br>
				<br>
				<hr>
				<br>
				<br>
		    <div class="bar-text" id="memory-bar-text"></div>
		    <div class="bar" id="memory-bar"></div>
				<br>
		    <div class="bar-text" id="bht-requests-bar-text"></div>
		    <div class="bar" id="bht-requests-bar"></div>
				<br>
		    <div class="bar-text" id="viewers-bar-text"></div>
		    <div class="bar" id="viewers-bar"></div>
				<br>
		    <div class="bar-text" id="users-total-bar-text"></div>
		    <div class="bar" id="users-total-bar"></div>
				<br>
		    <div class="bar-text" id="users-bar-text"></div>
		    <div class="bar" id="users-bar"></div>
				<br>
		    <div class="bar-text" id="test-users-bar-text"></div>
		    <div class="bar" id="test-users-bar"></div>
				<br>
		    <div class="bar-text" id="delta-response-bar-text"></div>
		    <div class="bar" id="delta-response-bar"></div>
				<br>
				<br>
	    	<table id='heartbeat_table' class'heartbeatTable'></table>

		  <div id='admin_panel' >
				<br/>
		    	<h2>ADMINS</h2>
				<br/>
				<button id="showHideButton" class="showHideButton" onclick="toggleConnectedAdmins()">show/hide connected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleDisconnectedAdmins()">show/hide disconnected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleIpAdmins()">show/hide admin ip</button>
				<br/>
				<br/>
			  <div id='server_admins' ></div>
			</div>

	    <div id='admins' ><ul id='admin_ip_list'></ul></div>
	    <hr>
	    <div id='admins' ><ul id='admin_session_list'></ul></div>

	    <br>
	    <hr>
	    <hr>

		  <div id='user_panel' >
				<br/>
		    	<h2>USERS</h2>
				<br/>
				<button id="showHideButton" class="showHideButton" onclick="toggleIpUsers()">show/hide user ip</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleConnectedUsers()">show/hide connected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleDisconnectedUsers()">show/hide disconnected</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleHideTestUsers()">show/hide test users</button>
				<button id="showHideButton" class="showHideButton" onclick="toggleHideBotUsers()">show/hide bot users</button>
				<br/>
				<br/>
			    <div id='server_users' ></div>
			</div>

	    <div id='users' >
	    	<table id='user_ip_table' class'userIpTable'>
	    		<thead id='user_ip_table_head'>
	    		</thead>
	    		<tbody id='user_ip_table_body'>
	    		</tbody>
	    	</table>
				<br/>
				<br/>
				<br/>
	    	<table id='user_session_table' class'userSessionTable'>
	    		<thead id='user_session_table_head'>
	    		</thead>
	    		<tbody id='user_session_table_body'>
	    		</tbody>
	    	</table>
	    </div>

	    <hr>

		<script type="text/javascript">

			var windowLoaded = false;

			var ONE_MB = 1024*1024;
			var ONE_GB = ONE_MB*1024;

			var defaultDateTimeFormat = "YYYY-MM-DD HH:mm:ss ZZ";
			var defaultTimePeriodFormat = "HH:mm:ss";

			var randomIntFromInterval = function (min,max) {
			  return Math.floor(Math.random()*(max-min+1)+min);
			}

			function getTimeNow() {
				var d = new Date();
				return d.getTime();
			}

			var mainAdminObj = { adminId: 'ADMIN_RANDOM_' + randomIntFromInterval(1000,9999)};

			var currentTime = getTimeNow();

			var heartBeatTimeoutFlag = false ;
			var serverCheckInterval = 1000 ;
			var maxServerHeartBeatWait = 30000 ;


			console.log("ADMIN PAGE");

			var adminConfig = {} ;

			var testMode = false ;

			adminConfig['testMode'] = testMode ;

			var searchByDateTimeEnable = false;
			var searchByDateTimeContinueEnable = false;
			var showTestUsers = true ;
			var showBotUsers = true ;

			// var socket = io.connect();
			var socket = io.connect('/admin');
			// var socket = io.connect('http://word.threeceelabs.com/admin');
			// var socket = io.connect('http://localhost:9997/admin');
			// var socket = io.connect('http://threeceedev.dyndns.org/');

			var googleOauthUrl = 0;

			var adminIpHashMap = new HashMap();
			var adminSocketIdHashMap = new HashMap();
			var numberAdminIpAddresses = adminIpHashMap.count();
			var showConnectedAdmins = true ;
			var showDisconnectedAdmins = false ;
			var showIpAdmins = true ;

			var adminIpHashMapKeys = [];
			var adminSocketIdHashMapKeys = [];

			var userIpHashMapKeys = [];
			var userSessionHashMapKeys = [];

			var userIpHashMap = new HashMap();
			var userSessionHashMap = new HashMap();
			var numberUserSessions = 0;
			var numberTestUserSessions = 0;
			var numberUserIpAddresses = userIpHashMap.count();

			var userConnectedColor = "#00aa00";
			var testUserConnectedColor = "#888888";
			var userDisconnectedColor = "#aa0000";
			var testUserDisonnectedColor = "#880000";
			var showConnectedUsers = true ;
			var showDisconnectedUsers = false ;
			var showIpUsers = true ;

			var userSessionTableHead = document.getElementById('user_session_table_head');
			var userSessionTableBody = document.getElementById('user_session_table_body');

			var userIpTableHead = document.getElementById('user_ip_table_head');
			var userIpTableBody = document.getElementById('user_ip_table_body');

			var startColor = '#008000';
			var midColor = '#F9CD2B';
			var endColor = '#CC0000';

			var memoryBar;
	    var memoryBarDiv = document.getElementById('memory-bar');
			memoryBar = new ProgressBar.Line(memoryBarDiv, {});
			memoryBar.animate(0);
	    var memoryBarText = document.getElementById('memory-bar-text');

			var bhtRequestsBar;
			var bhtRequestsBarPercent = 0;
	    var bhtRequestsBarDiv = document.getElementById('bht-requests-bar');
			bhtRequestsBar = new ProgressBar.Line(bhtRequestsBarDiv, {});
			bhtRequestsBar.animate(0);
	    var bhtRequestsBarText = document.getElementById('bht-requests-bar-text');

			var viewersBar;
	    var viewersBarDiv = document.getElementById('viewers-bar');
			viewersBar = new ProgressBar.Line(viewersBarDiv, {});
			viewersBar.animate(0);
	    var viewersBarText = document.getElementById('viewers-bar-text');

			var usersBar;
	    var usersBarDiv = document.getElementById('users-bar');
			usersBar = new ProgressBar.Line(usersBarDiv, {});
			usersBar.animate(0);
	    var usersBarText = document.getElementById('users-bar-text');

			var testUsersBar;
	    var testUsersBarDiv = document.getElementById('test-users-bar');
			testUsersBar = new ProgressBar.Line(testUsersBarDiv, {});
			testUsersBar.animate(0);
	    var testUsersBarText = document.getElementById('test-users-bar-text');

			var usersTotalTotalBar;
	    var usersTotalBarDiv = document.getElementById('users-total-bar');
			usersTotalBar = new ProgressBar.Line(usersTotalBarDiv, {});
			usersTotalBar.animate(0);
	    var usersTotalBarText = document.getElementById('users-total-bar-text');

	    var deltaResponsesMax = 1;
			var deltaResponseBar;
	    var deltaResponseBarDiv = document.getElementById('delta-response-bar');
			deltaResponseBar = new ProgressBar.Line(deltaResponseBarDiv, { duration: 200 });
			deltaResponseBar.animate(0);
	    var deltaResponseBarText = document.getElementById('delta-response-bar-text');

			var heartBeat = {} ;
			var lastTimeoutHeartBeat = null ;

			function setValue(id,newvalue) {
			  var s= document.getElementById(id);
			  s.value = newvalue;
			}    

			var jsonPrint = function (obj){
			  return JSON.stringify(obj, null, 2);
			}

			function getTimeStamp(inputTime) {
				var cDate, cTime;
				var options = {
				    weekday: "long", year: "numeric", month: "numeric",
				    day: "numeric", hour: "2-digit", hour12: false,  minute: "2-digit"
				  };

			  if (typeof inputTime === 'undefined') {
			    cDate = new Date().toDateString("en-US", options);
			    cTime = new Date().toTimeString('en-US', options);
			  }
			  else {
			    cDate = new Date(inputTime).toDateString("en-US", options);
			    cTime = new Date(inputTime).toTimeString('en-US', options);
			  }
			  return cDate + " - " + cTime;
			}

			function msToTime(duration) {
		    var milliseconds = parseInt((duration%1000)/100)
		        , seconds = parseInt((duration/1000)%60)
		        , minutes = parseInt((duration/(1000*60))%60)
		        , hours = parseInt((duration/(1000*60*60))%24)
		        , days = parseInt(duration/(1000*60*60*24));

		    var daysInt = days ;
		    days = (days < 10) ? "0" + days : days;
		    hours = (hours < 10) ? "0" + hours : hours;
		    minutes = (minutes < 10) ? "0" + minutes : minutes;
		    seconds = (seconds < 10) ? "0" + seconds : seconds;

		    if (daysInt > 0){
			    return days + " DAYS | " + hours + ":" + minutes + ":" + seconds ;
		    }
		    else{
			    return hours + ":" + minutes + ":" + seconds ;
		    }
			}

			function sortIpHashMapByConnectTime(ipHashMap){
			}

			function serverClear(){
				console.log("... CLEARING SERVER INFO ...\n");
				heartBeatTimeoutFlag = false ;
				adminIpHashMap.clear();
				adminSocketIdHashMap.clear();			
				userIpHashMap.clear();
				userSessionHashMap.clear();			
				updateServerHeartbeat(heartBeat, heartBeatTimeoutFlag, lastTimeoutHeartBeat);
			}

			function updateAdminConfig(config) {

				// var config = JSON.parse(rxConfig);

			  console.log("ADMIN CONFIG CHANGE\n" + jsonPrint(config));

			  if (typeof config.testMode !== 'undefined') {
			    console.log("   ---> CONFIG_CHANGE: testMode: " + config.testMode);
			    testMode = config.testMode;
			    setTestMode(config.testMode);
			  }
			}

			function tableCreateRow(parentTable, options, cells){

        var tr = parentTable.insertRow();
        var tdTextColor = options.textColor;
        var tdBgColor = options.backgroundColor || '#222222';

        if (options.trClass) {
        	tr.setAttribute("class", options.trClass);
        }

        if (options.headerFlag){
		      cells.forEach(function(content){
			      var th = tr.insertCell();
			      th.appendChild(document.createTextNode(content));
			      th.style.color = tdTextColor ;
			      th.style.backgroundColor = tdBgColor ;
		      });     	
        }
        else {
		      cells.forEach(function(content){
			      var td = tr.insertCell();
			      // var td2 = td.insertCell();
			      td.appendChild(document.createTextNode(content));
			      td.style.color = tdTextColor ;
			      td.style.backgroundColor = tdBgColor ;
		      });
        }
			}

			function requestSessions(reqSessionsOptions){
				console.log("TX REQ ADMIN SESSION\n" + JSON.stringify(reqSessionsOptions, null, 3));
				socket.emit('REQ_ADMIN_SESSION', reqSessionsOptions);
				console.log("TX REQ USER SESSION\n" + JSON.stringify(reqSessionsOptions, null, 3));
				socket.emit('REQ_USER_SESSION', reqSessionsOptions);
			}

			setInterval (function () {
				currentTime = getTimeNow();
				updateAdminConnect();
				updateUserConnect();
			}, 1000 );


			socket.on('connect', function(){
				serverConnected = true ;
				console.log("\n===== ADMIN SERVER CONNECTED =====\n" 
					+ getTimeStamp()
					);
				serverClear();
				if (windowLoaded) {
				  socket.emit("ADMIN_READY", mainAdminObj);
				}
			});

			socket.on('reconnect', function(){
				serverConnected = true ;
				console.log("\n===== ADMIN SERVER RECONNECTED =====\n" 
					+ getTimeStamp()
					);
				serverClear();
			  socket.emit("ADMIN_READY", mainAdminObj);
			});

			socket.on('disconnect', function(){
				serverConnected = false ;
				console.log("\n***** SERVER DISCONECTED *****\n" 
					+ getTimeStamp()
					);
				serverClear();
			});

		  socket.on("ADMIN_CONFIG", function(rxAdminConfig){
		    console.log("\n*** RX ADMIN CONFIG ***\n" 
		      // + rxAdminConfig);
		      + JSON.stringify(rxAdminConfig, null, 3));
		    updateAdminConfig(rxAdminConfig);
		  });

		  socket.on("CONFIG_CHANGE", function(rxAdminConfig){
		    var previousProperty ;
		  
		    console.log("\n*** RX ADMIN CONFIG CHANGE ***\n" 
		      + JSON.stringify(rxAdminConfig, null, 3));
		  
		    console.log("\nPREVIOUS ADMIN CONFIG:\n" + JSON.stringify(adminConfig, null, 3));
		    for(var configPropertyName in rxAdminConfig) {
		      console.log("configPropertyName: " + configPropertyName + " | " + rxAdminConfig[configPropertyName]);
		      if (typeof adminConfig !== 'undefined'){
			      previousProperty = adminConfig[configPropertyName];
		      }
		      adminConfig[configPropertyName] = rxAdminConfig[configPropertyName];
		      console.log(configPropertyName + " was: " + previousProperty + " | now: " + adminConfig[configPropertyName]);
		    }
		    console.log("\nNEW ADMIN CONFIG:\n" + JSON.stringify(adminConfig, null, 3));
		    updateAdminConfig(adminConfig);
		  });


			socket.on('ADMIN IP', function(rxIpObj){
				var ipObj = JSON.parse(rxIpObj) ;
				console.log("RXCD ADMIN IP  " + ipObj.ip + " | " + ipObj.domain);
				adminIpHashMap.set(ipObj.ip, ipObj);
				numberAdminIpAddresses = adminIpHashMap.count();
				adminIpHashMapKeys = adminIpHashMap.keys();
				adminIpHashMapKeys.sort();
			});

			socket.on('USER IP', function(rxIpObj){
				var ipObj = JSON.parse(rxIpObj) ;
				console.log("RXCD USER IP  " + ipObj.ip + " | " + ipObj.domain);
				userIpHashMap.set(ipObj.ip, ipObj);
				numberUserIpAddresses = userIpHashMap.count();
				userIpHashMapKeys = userIpHashMap.keys();
				userIpHashMapKeys.sort();
			});



			socket.on('ADMIN_ACK', function(adminSessionKey){

				console.log("RXCD ADMIN ACK: " + socket.id + " | KEY: " + adminSessionKey);

				var reqSessionsOptions = {
					requestSocketId: socket.id,
					requestNamespace: '/admin',
					sessionType: 'ALL', 
					sessionState: 'CONNECTED', 
					maxSessions: 10
				}

				requestSessions(reqSessionsOptions);
			});

			socket.on('ADMIN_SESSION', function(adminSessionObj){

				console.log("adminSessionObj\n" + jsonPrint(adminSessionObj));

				console.log("RX ADMIN SESSION: " 
					+ adminSessionObj.sessionId 
					+ " | UID: " + adminSessionObj.userId 
				);

				adminIpHashMap.set(adminSessionObj.ip, adminSessionObj);
				numberAdminIpAddresses = adminIpHashMap.count();

				adminSocketIdHashMap.set(adminSessionObj.sessionId, adminSessionObj);
				adminSocketIdHashMapKeys = adminSocketIdHashMap.keys();
				adminSocketIdHashMapKeys.sort();
				updateAdminConnect(adminSessionObj);
			});

			socket.on('USER_SESSION', function(userSessionObj){

				console.log("userSessionObj\n" + jsonPrint(userSessionObj));

				console.log("RX USER SESSION: " 
					+ userSessionObj.sessionId 
					+ " | UID: " + userSessionObj.userId 
				);

				userIpHashMap.set(userSessionObj.ip, userSessionObj);
				userIpHashMapKeys = userIpHashMap.keys();
				userIpHashMapKeys.sort();
				numberUserIpAddresses = userIpHashMapKeys.length;

				userSessionHashMap.set(userSessionObj.sessionId, userSessionObj);
				userSessionHashMapKeys = userSessionHashMap.keys();
				userSessionHashMapKeys.sort();
				numberUserSessions = userSessionHashMapKeys.length;

				updateUserConnect(userSessionObj);
			});

			socket.on("SESSION_UPDATE", function(sessionObject){
			  console.log("> RX " + sessionObject.sourceWord.nodeId + " > " + sessionObject.targetWord.nodeId) ;
			});

			var hbIndex = 0;
			
			socket.on('HEARTBEAT', function(rxHeartbeat){
				hbIndex++;
				heartBeat = rxHeartbeat ;
				// console.log("... HB\n" + jsonPrint(heartBeat));
				if (rxHeartbeat.deltaResponsesReceived > deltaResponsesMax) deltaResponsesMax = rxHeartbeat.deltaResponsesReceived;
				heartBeatTimeoutFlag = false ;
			});

			// updateServerHeartbeat
			var serverCheckTimeout = setInterval(function(){
				numberUserIpAddresses = userIpHashMap.count();
				numberAdminIpAddresses = adminIpHashMap.count();

				if (Date.now() > (heartBeat.timeStamp + maxServerHeartBeatWait)){
					heartBeatTimeoutFlag = true ;
					lastTimeoutHeartBeat = heartBeat ;
					console.error("***** SERVER HEARTBEAT TIMEOUT ***** " 
						+ getTimeStamp() 
						+ " | LAST SEEN: " + getTimeStamp(heartBeat.timeStamp)
						+ msToTime(Date.now() - heartBeat.timeStamp) + " AGO" 
					);
				}
 				updateServerHeartbeat(heartBeat, heartBeatTimeoutFlag, lastTimeoutHeartBeat);
			}, serverCheckInterval); ;

			function setTestMode(inputTestMode){

				var serverConfigUpdateFlag = false;

				if (typeof inputTestMode !== 'undefined'){
					serverConfigUpdateFlag = true ;
					testMode = inputTestMode;
				}
				else {
					testMode = !testMode;
				}
				console.log("testMode: " + testMode);

				var config = {
					testMode: testMode
				}

				if (testMode){
					document.getElementById("testModeButton").style.color="red";
					document.getElementById("testModeButton").style.border="2px solid red";
				}
				else {
					document.getElementById("testModeButton").style.color="white";
					document.getElementById("testModeButton").style.border="1px solid gray";
				}

				if (!serverConfigUpdateFlag){
					console.log("***> SENT CONFIG: " + JSON.stringify(config, null, 3));
					socket.emit('CONFIG', JSON.stringify(config));
				}
				else {
					console.log("---> UPDATED CONFIG: " + JSON.stringify(config, null, 3));
				}
			}

			function sendServerConfig(e){

				var config = {
					testMode: testMode
				}

				var configHasValues = false;

				if ((typeof e === 'undefined' ) || (e.keyCode == 13)) {
					if (configHasValues){
						console.log("***> SENT CONFIG: " + JSON.stringify(config, null, 3));
						socket.emit('CONFIG', JSON.stringify(config));
						return false ;
					}
					else {
						console.log("sendServerConfig: NO VALUES SET ... SKIPPING ...");
					}
				}
			}


			function setWordCacheTtl(){
				var newWordCacheTtl = document.getElementById("setWordCacheTtl").value;
				console.log("SET WORD CACHE TTL: " + newWordCacheTtl);
				socket.emit("SET_WORD_CACHE_TTL", newWordCacheTtl);
			}

			function updateBhtReqs(){
				var newBhtRequests = document.getElementById("updateBhtReqs").value;
				console.log("UPDATE BHT REQS: " + newBhtRequests);
				socket.emit("UPDATE_BHT_REQS", newBhtRequests);
			}

			function toggleTestMode(){
				console.log("SET TEST MODE: " + testMode);
				socket.emit("SET_TEST_MODE", testMode);
			}

			function toggleIpAdmins(){
				updateAdminConnect({ showIp: "toggle" });
			}

			function toggleConnectedAdmins(){
				updateAdminConnect({ showConnected: "toggle" });
			}

			function toggleDisconnectedAdmins(){
				updateAdminConnect({ showDisconnected: "toggle" });
			}

			function toggleIpUsers(){
				updateUserConnect({ showIp: "toggle" });
			}

			function toggleConnectedUsers(){
				updateUserConnect({ showConnected: "toggle" });
			}

			function toggleDisconnectedUsers(){
				updateUserConnect({ showDisconnected: "toggle" });
			}

			function toggleHideTestUsers(){
				updateUserConnect({ showTestUsers: "toggle" });
			}

			function toggleHideBotUsers(){
				updateUserConnect({ showBotUsers: "toggle" });
			}

			function updateAdminConnect(req) {

				numberAdminsConnected = 0;

				if (typeof req === 'undefined'){
				}
				else {
					if (req.showConnected == 'toggle') {
						showConnectedAdmins = !showConnectedAdmins ;
					}
					if (req.showDisconnected == 'toggle') {
						showDisconnectedAdmins = !showDisconnectedAdmins ;
					}
					if (req.showIp == 'toggle') {
						showIpAdmins = !showIpAdmins ;
					}
				}

				var adminIpListElement = document.getElementById("admin_ip_list");
				var adminSessionListElement = document.getElementById("admin_session_list");

				while(adminIpListElement.childNodes.length >= 1) {
					adminIpListElement.removeChild(adminIpListElement.firstChild);
				}
				
				while(adminSessionListElement.childNodes.length >= 1) {
					adminSessionListElement.removeChild(adminSessionListElement.firstChild);
				}
				
				if (showIpAdmins) {
					adminIpHashMap.forEach(function(value, key) {
						var adminIpListItem = document.createElement('li');
						adminIpListItem.style.color = userConnectedColor;

						adminIpListElement.appendChild(adminIpListItem);
						adminIpListItem.innerHTML = adminIpListItem.innerHTML 
							+ (
								key
								+ ' | ' + value.domain  
								+ ' | LAST SEEN: ' + getTimeStamp(value.lastSeen)
								+ ' | CONNECTIONS: ' + value.sessions 
							) ;
					});				
				}
				
				if (showConnectedAdmins) {
					adminSocketIdHashMap.forEach(function(value, key) {

						// console.log("showConnectedAdmins\n" + JSON.stringify(value));

					  if (value.connected == true) {

							var adminSessionListItem = document.createElement('li');					
							adminSessionListItem.style.color = userConnectedColor;
							adminSessionListElement.appendChild(adminSessionListItem);
							adminSessionListItem.innerHTML = adminSessionListItem.innerHTML 
								+ (value.ip 
								+ ' | ' + value.domain 
								+ ' | ' + key 
								+ ' | CONNECT: ' + getTimeStamp(value.connectTime)
								+ ' | DISCONNECT: ' + getTimeStamp(value.disconnectTime)
								+ ' | CONNECT TIME: ' + msToTime(heartBeat.timeStamp - value.connectTime)
								) ;
						}
					});			
				}		
				
				if (showDisconnectedAdmins) {
					adminSocketIdHashMap.forEach(function(value, key) {
					  if (value.connected == false) {

							var adminSessionListItem = document.createElement('li');					
							adminSessionListItem.style.color = userDisconnectedColor;
					    var timeConnected = value.disconnectTime - value.connectTime ;
							adminSessionListElement.appendChild(adminSessionListItem);
							adminSessionListItem.innerHTML = adminSessionListItem.innerHTML 
								+ (value.ip 
								+ ' | ' + value.domain 
								+ ' | ' + key 
								+ ' | CONNECT: ' + getTimeStamp(value.connectTime)
								+ ' | DISCONNECT: ' + getTimeStamp(value.disconnectTime)
								+ ' | CONNECT TIME: ' + msToTime(value.disconnectTime - value.connectTime)
								) ;
						}
					});			
				}		
			}

			function initUserConnect(options){
				// tableCreateRow(userIpTableHead, options, ['UNIQUE USERS']);  // 2nd arg is headerFlag
				tableCreateRow(userIpTableHead, options, ['USERS', 'IP', 'DOMAIN', 'LAST SEEN', 'AGO', 'SESSIONS']);  // 2nd arg is headerFlag
			}

			function initUserSession(options){
				// tableCreateRow(userSessionTableHead, options, ['USER SESSIONS']);  // 2nd arg is headerFlag
				tableCreateRow(userSessionTableHead, options, ['SESSIONS', 'IP', 'DOMAIN', 'SESSION', 'CONNECT', 'DISCONNECT', 'TIME CONNECTED']);  // 2nd arg is headerFlag
			}



			function updateUserConnect(req){

				var userIpTableBodyOptions = {
					headerFlag: false,
					textColor: '#AAAAAA',
					backgroundColor: 'black'
				};

				var userSessionTableBodyOptions = {
					headerFlag: false,
					textColor: '#AAAAAA',
					backgroundColor: 'black'
				};

				while(userIpTableBody.childNodes.length > 1) {
					userIpTableBody.removeChild(userIpTableBody.lastChild);
				}

				while(userSessionTableBody.childNodes.length > 1) {
					userSessionTableBody.removeChild(userSessionTableBody.lastChild);
				}

				if (typeof req === 'undefined'){
				}
				else {
					if (req.showConnected == 'toggle') {
						showConnectedUsers = !showConnectedUsers ;
						console.log("showConnectedUsers: " + showConnectedUsers);
					}
					if (req.showDisconnected == 'toggle') {
						showDisconnectedUsers = !showDisconnectedUsers ;
					}
					if (req.showIp == 'toggle') {
						showIpUsers = !showIpUsers ;
						console.log("showIpUsers " + showIpUsers);
					}
					if (req.showTestUsers == 'toggle') {
						showTestUsers = !showTestUsers ;
						console.log("showTestUsers " + showTestUsers);
					}
					if (req.showBotUsers == 'toggle') {
						showBotUsers = !showBotUsers ;
						console.log("showBotUsers " + showBotUsers);
					}
				}

				if (showIpUsers) {

					var numberUniqueUsers = 0;
					var elapsedSinceLastSeen = 0;
					var key;
					var value = {};

					for (var i=0; i<userIpHashMapKeys.length; i++){

						key = userIpHashMapKeys[i];
						value = userIpHashMap.get(userIpHashMapKeys[i]);

						if (!showBotUsers && ((value.domain.indexOf("googlebot") >= 0))) {
						}
						else if (!showTestUsers && (value.namespace == 'test-user')) {
						}
						else {
							
							if (value.namespace == 'test-user') {
								userIpTableBodyOptions.textColor = testUserConnectedColor ;
							}
							else{
								userIpTableBodyOptions.textColor = userConnectedColor ;
							}

							numberUniqueUsers++;

							if (value.connected == true) {
								elapsedSinceLastSeen = 0 ;
							}
							else if (value.lastSeen > currentTime) {
								elapsedSinceLastSeen = 0 ;
							}
							else {
								elapsedSinceLastSeen = heartBeat.timeStamp - value.lastSeen;
							}

							tableCreateRow(userIpTableBody, userIpTableBodyOptions, 
								[
									numberUniqueUsers,
									key, 
									value.domain, 
									getTimeStamp(value.lastSeen), 
									msToTime(elapsedSinceLastSeen),
									// value.sessions.length
								]
							);
						}
					}			
				}

				if (showConnectedUsers) {

					userSessionTableBodyOptions.textColor = userConnectedColor ;

					var numberConnected = 0;
					var connectTime = 0;
					var sessionId;
					var sessionObj = {};


					for (var j=0; j<userSessionHashMapKeys.length; j++){

						sessionId = userSessionHashMapKeys[j];
						sessionObj = userSessionHashMap.get(userSessionHashMapKeys[j]);

						if (typeof sessionObj.referer === 'undefined'){
							sessionObj.referer = '';
						}


						if (!showTestUsers && (sessionObj.namespace == 'test-user'))
						{
						}
						else if (!showBotUsers && ((sessionObj.domain.indexOf("googlebot") >= 0))) {
						}
						else{
							if (sessionObj.connected == true) { 

								numberConnected++;

								if (sessionObj.namespace == 'test-user') {
									userSessionTableBodyOptions.textColor = testUserConnectedColor ;
								}
								else if (sessionObj.domain.indexOf("googlebot") >= 0) {
									userSessionTableBodyOptions.textColor = testUserConnectedColor ;
								}
								else if (sessionObj.domain.indexOf("googleusercontent") >= 0) {
									userSessionTableBodyOptions.textColor = testUserConnectedColor ;
								}
								else{
									userSessionTableBodyOptions.textColor = userConnectedColor ;
								}
								
								// console.log("sessionId: " + sessionId + "\n" + jsonPrint(sessionObj));
								// console.log("heartBeat.timeStamp: " + heartBeat.timeStamp + " | " + sessionObj.connectTime);
								connectTime = heartBeat.timeStamp - sessionObj.connectTime ;

								tableCreateRow(userSessionTableBody, userSessionTableBodyOptions, 
									[
										numberConnected,
										sessionObj.ip, 
										sessionObj.domain, 
										sessionId, 
										getTimeStamp(sessionObj.connectTime), 
										'', 
										msToTime(connectTime)
									]
								);
							}
						}
					}

				}		

				if (showDisconnectedUsers) {

					userSessionTableBodyOptions.textColor = userDisconnectedColor ;

					var numberDisconnected = 0;
					var connectedTime = 0;

					for (var k=0; k<userSessionHashMapKeys.length; k++){

						var key = userSessionHashMapKeys[k];
						var value = userSessionHashMap.get(userSessionHashMapKeys[k]);

						if (!showTestUsers && (value.namespace == 'test-user')) {
						}
						else{
							if (value.connected == false) { 

								numberDisconnected++;

								connectedTime = value.disconnectTime - value.connectTime ;
							    
								tableCreateRow(userSessionTableBody, userSessionTableBodyOptions, 
									[
										numberDisconnected,
										value.ip, 
										value.domain, 
										key, 
										getTimeStamp(value.connectTime), 
										getTimeStamp(value.disconnectTime), 
										msToTime(connectedTime)
									]
								);

							}
						}
					}			
				}		
			}

			function updateServerHeartbeat(heartBeat, timeoutFlag, lastTimeoutHeartBeat) {

				// console.log("updateServerHeartbeat: timeoutFlag: " + timeoutFlag);

				var memoryAvailable = heartBeat.memoryAvailable/heartBeat.memoryTotal;
				var memoryUsed = (heartBeat.memoryTotal-heartBeat.memoryAvailable)/heartBeat.memoryTotal;

				memoryBar.animate(memoryUsed);

				if (100*memoryUsed >= 90) {
					memoryBar.path.setAttribute('stroke', endColor);
				}
				else if (100*memoryUsed >= 70) {
					memoryBar.path.setAttribute('stroke', midColor);
				}
				else {
					memoryBar.path.setAttribute('stroke', startColor);
				}

				memoryBarText.innerHTML =  
					'MEMORY (GB)'
					+ ' | ' + (heartBeat.memoryTotal/ONE_GB).toFixed(2) + ' TOT' 
					+ ' | ' + ((heartBeat.memoryTotal-heartBeat.memoryAvailable)/ONE_GB).toFixed(2) + ' USED' 
					+ ' (' + (100*memoryUsed).toFixed(1) + ' %)' 
					+ ' | ' + (heartBeat.memoryAvailable/ONE_GB).toFixed(2) + ' AVAIL' 
					+ ' (' + 100*memoryAvailable.toFixed(3) + ' %)' 
				;


				bhtRequestsBar.animate(heartBeat.bhtRequests/heartBeat.bhtRequestLimit);

				if (100*heartBeat.bhtRequests/heartBeat.bhtRequestLimit >= 90) {
					bhtRequestsBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.bhtRequests/heartBeat.bhtRequestLimit >= 50) {
					bhtRequestsBar.path.setAttribute('stroke', midColor);
				}
				else {
					bhtRequestsBar.path.setAttribute('stroke', startColor);
				}

				bhtRequestsBarText.innerHTML =  
					'BHT REQS'
					+ ' | USED: ' + heartBeat.bhtRequests + ' ' + (heartBeat.bhtRequests/heartBeat.bhtRequestLimit * 100).toFixed(0) + '%'
					+ ' | REMAIN: ' + (heartBeat.bhtRequestLimit - heartBeat.bhtRequests)
				;


				viewersBar.animate(heartBeat.numberViewers/heartBeat.numberViewersMax);

				if (100*heartBeat.numberViewers/heartBeat.numberViewersMax >= 90) {
					viewersBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberViewers/heartBeat.numberViewersMax >= 50) {
					viewersBar.path.setAttribute('stroke', midColor);
				}
				else {
					viewersBar.path.setAttribute('stroke', startColor);
				}

				viewersBarText.innerHTML = (heartBeat.numberViewers) + ' VIEWERS | ' + (heartBeat.numberViewersMax) + ' MAX | ' + moment(heartBeat.numberViewersMaxTime).format(defaultDateTimeFormat);


				usersTotalBar.animate(heartBeat.numberUsersTotal/heartBeat.numberUsersTotalMax);

				if (100*heartBeat.numberUsersTotal/heartBeat.numberUsersTotalMax >= 90) {
					usersTotalBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberUsersTotal/heartBeat.numberUsersTotalMax >= 50) {
					usersTotalBar.path.setAttribute('stroke', midColor);
				}
				else {
					usersTotalBar.path.setAttribute('stroke', startColor);
				}

				usersTotalBarText.innerHTML = (heartBeat.numberUsersTotal) + ' TOTAL USERS | ' + (heartBeat.numberUsersTotalMax) + ' MAX | ' + moment(heartBeat.numberUsersTotalMaxTime).format(defaultDateTimeFormat);


				usersBar.animate(heartBeat.numberUsers/heartBeat.numberUsersMax);

				if (100*heartBeat.numberUsers/heartBeat.numberUsersMax >= 90) {
					usersBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberUsers/heartBeat.numberUsersMax >= 50) {
					usersBar.path.setAttribute('stroke', midColor);
				}
				else {
					usersBar.path.setAttribute('stroke', startColor);
				}

				usersBarText.innerHTML = (heartBeat.numberUsers) + ' USERS | ' + (heartBeat.numberUsersMax) + ' MAX | ' + moment(heartBeat.numberUsersMaxTime).format(defaultDateTimeFormat);


				testUsersBar.animate(heartBeat.numberTestUsers/heartBeat.numberTestUsersMax);

				if (100*heartBeat.numberTestUsers/heartBeat.numberTestUsersMax >= 90) {
					testUsersBar.path.setAttribute('stroke', endColor);
				}
				else if (100*heartBeat.numberTestUsers/heartBeat.numberTestUsersMax >= 50) {
					testUsersBar.path.setAttribute('stroke', midColor);
				}
				else {
					testUsersBar.path.setAttribute('stroke', startColor);
				}

				testUsersBarText.innerHTML = (heartBeat.numberTestUsers) + ' TEST USERS | ' + (heartBeat.numberTestUsersMax) + ' MAX | ' + moment(heartBeat.numberTestUsersMaxTime).format(defaultDateTimeFormat);


				deltaResponseBar.animate(heartBeat.deltaResponsesReceived/deltaResponsesMax);

				if (heartBeat.deltaResponsesReceived >= 90) {
					deltaResponseBar.path.setAttribute('stroke', endColor);
				}
				else if (heartBeat.deltaResponsesReceived >= 50) {
					deltaResponseBar.path.setAttribute('stroke', midColor);
				}
				else {
					deltaResponseBar.path.setAttribute('stroke', startColor);
				}

				deltaResponseBarText.innerHTML = heartBeat.deltaResponsesReceived + ' RESPONSES/SEC | ' + deltaResponsesMax + ' MAX';




		    var heatbeatTable = document.getElementById('heartbeat_table');

				while(heatbeatTable.childNodes.length > 0) {
					heatbeatTable.removeChild(heatbeatTable.firstChild);
				}

				tableCreateRow(heatbeatTable, false, ['LOCAL TIME', getTimeStamp()]);

				if (timeoutFlag){
					tableCreateRow(heatbeatTable, false, ['*** SERVER TIMEOUT ***', (msToTime(Date.now() - heartBeat.timeStamp)) + ' AGO']);
					var x = heatbeatTable.getElementsByTagName("td");
					x[2].style.color = "white";            
					x[2].style.backgroundColor = "red";            
				}
				else if (lastTimeoutHeartBeat){

					tableCreateRow(
						heatbeatTable, 
						false, 
						[
							'* SERVER TIMEOUT *', 
							getTimeStamp(lastTimeoutHeartBeat.timeStamp), 
							msToTime(Date.now() - lastTimeoutHeartBeat.timeStamp) + ' AGO'
						]);	

					var x = heatbeatTable.getElementsByTagName("td");
					x[2].style.color = "white";            
					x[2].style.backgroundColor = '#880000';            
				}

				var bhtOLTmoment;

				if (heartBeat.bhtOverLimitTime == 0) {
					bhtOLTmoment = "" ;
				}
				else {
					bhtOLTmoment = moment(heartBeat.bhtOverLimitTime).format("YYYY-MM-DD HH:mm:ss ZZ");
				}
				var bhtLRTmoment = moment(heartBeat.bhtLimitResetTime).format("YYYY-MM-DD HH:mm:ss ZZ");

				var bhtOptions = false ;
				// var memoryAvailable = (heartBeat.memoryAvailable/heartBeat.memoryTotal)*100;

				tableCreateRow(heatbeatTable, false, ['SERVER TIME', getTimeStamp(heartBeat.timeStamp)]);
				tableCreateRow(heatbeatTable, false, ['SERVER UPTIME', msToTime(heartBeat.upTime)]);
				tableCreateRow(heatbeatTable, false, ['APP START TIME', getTimeStamp(heartBeat.startTime)]);
				tableCreateRow(heatbeatTable, false, ['APP RUNTIME', msToTime(heartBeat.runTime)]);
				// tableCreateRow(heatbeatTable, false, ['MEM AVAIL', memoryAvailable.toFixed(1) + '%'
				// 	+ ' (' + parseInt(heartBeat.memoryAvailable/ONE_MB) + ' OF '
				// 	+ parseInt(heartBeat.memoryTotal/ONE_MB) + ' MB)'
				// 	]);

				if (typeof heartBeat.wordCacheStats !== 'undefined') {

					var hmr = (heartBeat.wordCacheStats.hits/(1+heartBeat.wordCacheStats.misses)) ;

					tableCreateRow(heatbeatTable, false, ['WORD CACHE', 
						'TTL: ' + heartBeat.wordCacheTtl
						+ ' | K: ' + heartBeat.wordCacheStats.keys
						+ ' | H: ' + heartBeat.wordCacheStats.hits
						+ ' | M: ' + heartBeat.wordCacheStats.misses
						+ ' | HMR: ' + hmr.toFixed(2)
						]);

					// tableCreateRow(heatbeatTable, false, ['WORD CACHE', 
					// 	'TTL: ' + heartBeat.wordCacheTtl,
					// 	'K: ' + heartBeat.wordCacheStats.keys,
					// 	'H: ' + heartBeat.wordCacheStats.hits,
					// 	'M: ' + heartBeat.wordCacheStats.misses,
					// 	'HMR: ' + hmr.toFixed(2)
					// 	]);

				}

				tableCreateRow(heatbeatTable, false, ['TOTAL SESSIONS', heartBeat.totalSessions]);
				tableCreateRow(heatbeatTable, false, ['TOTAL WORDS', heartBeat.totalWords]);
				tableCreateRow(heatbeatTable, false, ['TOTAL PROMPTS', heartBeat.promptsSent]);
				tableCreateRow(heatbeatTable, false, ['TOTAL REPONSES', heartBeat.responsesReceived]);

				if (heartBeat.bhtOverLimitFlag){
			    var now = moment.utc();
			    now.utcOffset("-08:00");

			    bhtOptions = {textColor: "black", backgroundColor: "#999947"} ;

					tableCreateRow(heatbeatTable, bhtOptions, ['*** BHT OVER LIMIT ***', 
						(msToTime(now.diff(heartBeat.bhtOverLimitTime))) + ' AGO | ' 
						+ (msToTime(moment(heartBeat.bhtLimitResetTime).diff(now))) + ' REMAIN']);
				}

				// tableCreateRow(heatbeatTable, bhtOptions, ['TOTAL BHT REQS', heartBeat.bhtRequests]);
				tableCreateRow(heatbeatTable, bhtOptions, ['BHT OVER LIMIT', bhtOLTmoment]);
				tableCreateRow(heatbeatTable, bhtOptions, ['BHT LIMIT RESET', 
						bhtLRTmoment + ' | ' + (msToTime(moment(heartBeat.bhtLimitResetTime).diff(now))) + ' REMAIN'
					]);

				tableCreateRow(heatbeatTable, false, ['TOTAL MW REQS', heartBeat.mwRequests]);

				tableCreateRow(heatbeatTable, false, ['ADMINS', heartBeat.numberAdmins]);
				tableCreateRow(heatbeatTable, false, ['UTILS', heartBeat.numberUtils]);
				// tableCreateRow(heatbeatTable, false, ['VIEWERS',heartBeat.numberViewers]);
				// tableCreateRow(heatbeatTable, false, ['TEST VIEWERS',heartBeat.numberTestViewers]);
				// tableCreateRow(heatbeatTable, false, ['USERS', heartBeat.numberUsers]);
				// tableCreateRow(heatbeatTable, false, ['TEST USERS',heartBeat.numberTestUsers]);
				// tableCreateRow(heatbeatTable, false, ['TOTAL USERS', heartBeat.numberUsers + heartBeat.numberTestUsers]);
				// tableCreateRow(heatbeatTable, false, ['MAX USERS', heartBeat.maxNumberUsers]);
				// tableCreateRow(heatbeatTable, false, ['MAX USERS TIME', getTimeStamp(heartBeat.maxNumberUsersTime)]);

				serverHeartbeatElement = document.getElementById("server_admins");

				while(serverHeartbeatElement.childNodes.length >= 1) {
					serverHeartbeatElement.removeChild(serverHeartbeatElement.firstChild);
				}

				serverHeartbeatElement.appendChild(serverHeartbeatElement.ownerDocument
					.createTextNode(numberAdminIpAddresses + " ADMINS UNIQUE IP " 
						+ " | " + heartBeat.numberAdmins + " CONNECTED"
						)
				);

				serverHeartbeatElement = document.getElementById("server_users");

				while(serverHeartbeatElement.childNodes.length >= 1) {
					serverHeartbeatElement.removeChild(serverHeartbeatElement.firstChild);
				}
				serverHeartbeatElement.appendChild(serverHeartbeatElement.ownerDocument
					.createTextNode(numberUserIpAddresses + " USER UNIQUE IP " + " | " + heartBeat.numberUsers + " USERS" + " | " + heartBeat.numberTestUsers + " TEST USERS")
				);
			}

			initUserConnect({
				headerFlag: true,
				textColor: '#CCCCCC',
				backgroundColor: '#222222'
			});

			initUserSession({
				headerFlag: true,
				textColor: '#CCCCCC',
				backgroundColor: '#222222'
			});

			window.onload=function() {
				console.log("WINNDOW LOADED");
				windowLoaded = true;
			  // socket.emit("ADMIN_READY", mainAdminObj);
			}			


		</script>

	</body>
</html>